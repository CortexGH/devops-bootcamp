---
docs/4-software-development-practices/4.5.6-sonarqube.md:
  category: Software Quality
  estReadingMinutes: 10
  exercises:
    -
      name: Setup SonarQube and Jenkins Integration
      description: Create a SonarQube server and add GitHub action to run SonarQube in our build pipeline.
      estMinutes: 180
      technologies:
      - SonarQube
      - GitHub Actions
---

# SonarQube

[SonarQube](https://www.sonarqube.org/) is an open source source code analysis platform. It can be integrated with a variety of continuous integration tools to automate code quality tests. With minimal configuration it includes a suite of test to detect bugs, code smells and security vulnerabilities.

![SonarQube image](img4/sonarqube_light.svg ':size=400px :class=light-mode-img-center :alt= SonarQube image; light mode')
![SonarQube image](img4/sonarqube_dark.svg ':size=400px :class=dark-mode-img-center :alt= SonarQube image; dark mode')

## Goals

This section will give you experience with:

- Installing a SonarQube server
- Expose SonarQube server with ngrok
- Configuring GitHub to run the SonarQube scan in GitHub actions

### Create new SonarQube service

Here we will setup a new SonarQube server which will listen for requests from our Jenkins pipeline to scan our code.

1. Create a new virtual host and expose port 9000.
2. Install SonarQube [Installation Instructions](https://docs.sonarqube.org/latest/setup/install-server/).
3. Log into SonarQube [http://localhost:9000](http://localhost:9000). The default username and password is `admin` and `admin`.
4. Go to to Administration -> Security -> Users and click on the Update Tokens button.
![SonarQube security image](img4/sonarqube-security_users.webp ':class=img-shadow-center :alt= SonarQube security image')
5. Generate a new token and make sure to save it.

### Expose SonarQube server with ngork
In order for GitHub to access your local instance of SonarQub we will need the help of ngork to expose it.

1. Sign up for ngork (it is free so use desired email address)
2. [Install ngork](https://ngrok.com/download)
```
brew install ngrok/ngrok/ngrok
```
3. Collect your [authentication token](https://dashboard.ngrok.com/get-started/your-authtoken) under Getting Started >> Your Authtoken
4. Authenticate ngork in a terminal
```
ngrok config add-authtoken <token>
```
5. Expose port port 9000 with ngork
```
ngrok http 9000
```
6. Collect https url provided by ngork output (you will need this for GitHub configuration)

### Configure the GitHub repo to run SonarQube scanner

1. Navigate to repo in GitHub >> Settings >> Secrets >> Action and add the following secrets:
```
SONARQUBE_HOST=<the https url collected from ngork>
SONARQUBE_TOKEN=<the token created in SonarQube>
```

2. Add [GitHub action definition](https://github.com/marketplace/actions/sonarqube-scan#usage) for SonarQube scan to project
```yml
on:
  # Trigger analysis when pushing in main or pull requests, and when creating
  # a pull request. 
  push:
    branches:
      - main
  pull_request:
      types: [opened, synchronize, reopened]

name: SonarQube Scan
jobs:
  sonarqube:
    name: SonarQube Trigger
    runs-on: ubuntu-latest
    steps:
    - name: Checking out
      uses: actions/checkout@main
      with:
        # Disabling shallow clone is recommended for improving relevancy of reporting
        fetch-depth: 0
    - name: SonarQube Scan
      uses: kitabisa/sonarqube-action@v1.2.0
      with:
        host: ${{ secrets.SONARQUBE_HOST }}
        login: ${{ secrets.SONARQUBE_TOKEN }}
```

3. Commit and push changes
4. View actions ran for GitHub repo (scan should be successful)
5. Navigate back to your SonarQube instance and view the projects tab
6. Click on your project name and review the scan results

> Info: [Official Github SonarQubee Scan with Github Action](https://github.com/marketplace/actions/official-sonarqube-scan)

### Deliverable
Discuss some of the advantages and disadvantages of using SonarQube in continuous integration.